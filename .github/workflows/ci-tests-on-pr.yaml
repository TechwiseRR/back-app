name: PR CI (Laravel tests + build)

on:
  pull_request:
    branches: [ main, preprod, dev ]

permissions:
  contents: read

concurrency:
  group: pr-ci-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    env:
      # ---- Laravel (env CI) ----
      APP_ENV: testing
      # Clé fixe pour la CI (suffisante pour les tests)
      APP_KEY: base64:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
      CACHE_DRIVER: array
      QUEUE_CONNECTION: sync
      SESSION_DRIVER: array
      # ---- DB SQLite éphémère ----
      DB_CONNECTION: sqlite
      DB_DATABASE: ${{ github.workspace }}/database/database.sqlite
      # ---- Composer (optimisations) ----
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------- PHP / Composer ----------
      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'   # lock 8.2 car composer.lock exige 8.1/8.2
          tools: composer:v2
          extensions: mbstring, sqlite3, pdo_sqlite, gd, bcmath, intl
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --no-progress --ansi

      # ---------- Préparation .env ----------
      - name: Préparer le fichier .env (robuste)
        run: |
          # Crée .env à partir de .env.example, sinon fallback minimal
          if [ ! -f .env ]; then
            if [ -f .env.example ]; then
              cp .env.example .env
            else
              cat > .env <<'EOF'
APP_NAME=Laravel
APP_ENV=testing
APP_DEBUG=true
APP_URL=http://localhost

LOG_CHANNEL=stack

DB_CONNECTION=${DB_CONNECTION}
DB_DATABASE=${DB_DATABASE}

CACHE_DRIVER=${CACHE_DRIVER}
QUEUE_CONNECTION=${QUEUE_CONNECTION}
SESSION_DRIVER=${SESSION_DRIVER}
APP_KEY=
EOF
            fi
          fi

          # Injecte APP_KEY si manquant
          if ! grep -q '^APP_KEY=' .env; then
            echo "APP_KEY=${APP_KEY}" >> .env
          fi

          echo "------ Aperçu .env ------"
          grep -E '^(APP_ENV|APP_KEY|DB_CONNECTION|DB_DATABASE|CACHE_DRIVER|QUEUE_CONNECTION|SESSION_DRIVER)=' .env || true
          echo "-------------------------"

      - name: Clear/optimize config (optionnel)
        run: |
          php artisan config:clear
          php artisan config:cache

      # ---------- Base SQLite ----------
      - name: Créer la base SQLite
        run: |
          mkdir -p database
          touch database/database.sqlite

      - name: Migrations (si nécessaires)
        run: php artisan migrate --force
        # Si tes tests seedent la DB eux-mêmes, tu peux commenter cette step.

      - name: Lancer les tests (Pest ou PHPUnit)
        run: |
          if [ -f ./vendor/bin/pest ]; then
            ./vendor/bin/pest -v
          else
            php artisan test -v
          fi

      # ---------- Frontend (Vite) ----------
      - name: Détecter le gestionnaire de paquets
        id: pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          elif [ -f package-lock.json ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Le cache intégré d'actions/setup-node ne gère que npm/yarn.
          cache: ${{ steps.pm.outputs.manager == 'npm' && 'npm' || (steps.pm.outputs.manager == 'yarn' && 'yarn' || '') }}

      - name: Installer pnpm (si nécessaire)
        if: ${{ steps.pm.outputs.manager == 'pnpm' }}
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm store
        if: ${{ steps.pm.outputs.manager == 'pnpm' }}
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-

      - name: Installer dépendances front
        run: |
          if [ "${{ steps.pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Build assets (Vite)
        run: |
          if [ "${{ steps.pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build --if-present
          fi

      - name: Upload artifacts (optionnel)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: public-build
          path: |
            public/build
            public/hot
          if-no-files-found: ignore
